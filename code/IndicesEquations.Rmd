---
title: "Indices Equations"
author: "E. Gurarie, S. Potluri, B. Fagan, others"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: yes
    toc_float: yes
---


Simulations are run until a (quasi)-equilibrium state is achieved, where "state" refers to the population distribution across an entire year. Once that state is attained, we obtain three metrics that characterize the spatial distribution, the migratory behavior, and the foraging efficiency. All of these indices are constrained to be between 0 and 1.   


## Migratoriness 

To determine the migratoriness of a population, we calculate overlap of the population from two different times within the year, choosing those times to minimize the overlap, and reporting the overal.  The overlap is defined as:

$$O(t_1, t_2) = \int_D \sqrt{u(x, t_1) \, u(x, t_2)} \, dx; $$
After calcuating this overlap of the two matrices that contain the population, we find the values of $t_1$ and $t_2$ that minimize $O$, corresponding to the periods of maximum distance.  Thus, the migratoriness index is:

$$MI = min(O(t_1, t_2))$$

```{r}
 findMinOverlap <- function(P, world = world){
    
    getOverlap <- function(i1, i2, P){
      sum(sqrt(P[i1,] * P[i2,])) * world$dx
    }
    
    Overlap <- matrix(NA, world$tau, world$tau)
    for(i in 1:(world$tau-1))
      for(j in (i+1):world$tau)
        Overlap[i,j] <- sum(sqrt(P[i,] * P[j,])) * world$dx
    
    minOverlap <-  min(Overlap, na.rm = TRUE)
    list(times = which(Overlap == minOverlap, arr.ind = TRUE),
         overlap = minOverlap)
  }
  

```

## Foraging Success 


To quantify the consumers’ ability to track the distribution of their resources over space and time, we use the continuous form of the Bhattacharya Coefficient (BC; Bhattacharyya 1943).  The BC quantifies similarity between two distributions; we take the mean of the BC over the equilibrium year. Thus: 
$$BC = {1\over T} \int_T\int_D \sqrt{u(x,t) \, h(x,t)} \, dx\,dt$$
Where the spatial integral is taken over the domain ($D$).  

The Bhattacharyya coefficient determines the probability of the overlap between the two distributions. Thus $0 \ge BC(p,q) \ge 1$. A larger Bhattacharyya coefficient indicates a smaller Bhattacharyya distance to show that the two distributions are similar. A larger distance indicates that the population is farther away from the resource at the given year. 

```{r}
require(bio3d)
  BhattacharyyaDistance <- function(i1, i2){
    BhattacharyyaCoefficient <- bhattacharyya(cov(i1), cov(i2), q=99.9) #do we need a q value?
    distance <- -log(BhattacharyyaCoefficient)
    list(distance)
  }
```

We used the `bhattacharyya` function in the `bio3d` package (Grant et al. 2006).


## Social Cohesion

To measure the social cohesion (SC) of a population, we simply calculate the mean standard deviation of the population across the equilibrium year:

$$\overline{\sigma} = {1\over \tau} \int \sigma_u(t) \,dt$$

where $$\sigma_u^2(t) = \int_D \left(x - \mu_u(t)\right)^2 \, u(x,t)\, dx$$

and $\mu_u$ is the mean of $u$ at time $t$.  If the population is uniformly distributed over the domain, the standard deviation of the model would be $\frac{X_{max}}{\sqrt{12}}$.  Where therefore define the social cohesion index as: $$SC = 1-\frac{\sqrt{12} \, }{X_{max}}\overline{\sigma}$$

where $\sigma_{max}=\frac{1}{\sqrt{12}}.$  In theory, SC can be lower than 1 if, for example, the population concentrates in two groups at the edges of the domain, but in practice the SC is positive.  The maximum value of 1 would correspond to the entire population . 
```{r}
 getSD <- function(f, world){
    EX <- sum( world$X * f) * world$dx
    EX2 <- sum( world$X^2 * f) * world$dx
    sd  = sqrt(EX2 - EX^2)
  }

  computeCohesiveness <- function(P){
    SDs <- apply(P, 1, getSD, world = world)
    SD.max <- (1/sqrt(12))*max(world$X)
    SC <- 1 - SDs/SD.max
    c(SC.mean = mean(SC), SC.sd = sd(SC))
  }

```


## References

Bhattacharyya, A. On a measure of divergence between two statistical populations defined by their probability distributions. Bull. Calcutta Math. Soc. 35 (1943), 99–109.

Grant, B.J. et al. (2006) Bioinformatics 22, 2695--2696.